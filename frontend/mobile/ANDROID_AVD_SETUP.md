# H∆∞·ªõng d·∫´n Test v·ªõi Android Virtual Device (AVD) tr√™n Android Studio

## üì± T·ªïng quan

Android Virtual Device (AVD) l√† emulator ch√≠nh th·ª©c c·ªßa Google, ƒë∆∞·ª£c t√≠ch h·ª£p s·∫µn trong Android Studio. ƒê√¢y l√† c√¥ng c·ª• test ph·ªï bi·∫øn nh·∫•t cho Android development.

---

## üì¶ B∆∞·ªõc 1: C√†i ƒë·∫∑t Android Studio

### 1.1. Download Android Studio

1. Truy c·∫≠p: [https://developer.android.com/studio](https://developer.android.com/studio)
2. Download **Android Studio** (Latest version)
3. File size: ~1GB

### 1.2. C√†i ƒë·∫∑t Android Studio

1. Ch·∫°y file installer
2. Ch·ªçn **Standard Installation**
3. Ch·ªçn UI theme (Light/Dark)
4. ƒê·ª£i download Android SDK, Android SDK Platform, Android Virtual Device

**Components s·∫Ω ƒë∆∞·ª£c c√†i ƒë·∫∑t:**
- Android SDK
- Android SDK Platform
- Android SDK Build-Tools
- Android Emulator
- Android SDK Platform-Tools
- Intel x86 Emulator Accelerator (HAXM) ho·∫∑c Hyper-V

### 1.3. Ki·ªÉm tra c√†i ƒë·∫∑t

M·ªü Android Studio v√† ki·ªÉm tra:
- **File** ‚Üí **Settings** (ho·∫∑c Ctrl+Alt+S)
- **Appearance & Behavior** ‚Üí **System Settings** ‚Üí **Android SDK**
- Xem SDK Path: `C:\Users\<YourName>\AppData\Local\Android\Sdk`

---

## üîß B∆∞·ªõc 2: C·∫•u h√¨nh Android SDK

### 2.1. C√†i ƒë·∫∑t SDK Platforms

1. M·ªü Android Studio
2. **File** ‚Üí **Settings** ‚Üí **Android SDK**
3. Tab **SDK Platforms**
4. Tick c√°c Android versions b·∫°n c·∫ßn (khuy·∫øn ngh·ªã):

   **Recommended:**
   - ‚úÖ **Android 13.0 (Tiramisu)** - API Level 33
   - ‚úÖ **Android 12.0 (S)** - API Level 31
   - ‚úÖ **Android 11.0 (R)** - API Level 30
   - ‚úÖ **Android 10.0 (Q)** - API Level 29

5. Click **Apply** ‚Üí **OK**
6. ƒê·ª£i download (m·ªói version ~200-300MB)

### 2.2. C√†i ƒë·∫∑t SDK Tools

1. Trong **Android SDK**, chuy·ªÉn sang tab **SDK Tools**
2. Tick c√°c tools sau:

   **Required:**
   - ‚úÖ **Android SDK Build-Tools**
   - ‚úÖ **Android SDK Command-line Tools**
   - ‚úÖ **Android Emulator**
   - ‚úÖ **Android SDK Platform-Tools**
   - ‚úÖ **Intel x86 Emulator Accelerator (HAXM installer)** (cho Intel CPU)
   
   **Optional:**
   - ‚úÖ **Google Play Services**
   - ‚úÖ **Google USB Driver** (cho physical device)

3. Click **Apply** ‚Üí **OK**

### 2.3. C√†i ƒë·∫∑t HAXM (Intel) ho·∫∑c Hyper-V (AMD)

#### **Cho Intel CPU:**

1. Sau khi download HAXM, v√†o:
   ```
   C:\Users\<YourName>\AppData\Local\Android\Sdk\extras\intel\Hardware_Accelerated_Execution_Manager
   ```
2. Ch·∫°y file `intelhaxm-android.exe`
3. Follow h∆∞·ªõng d·∫´n c√†i ƒë·∫∑t
4. Allocate RAM: 2-4GB

#### **Cho AMD CPU ho·∫∑c Windows 11:**

D√πng **Hyper-V** thay v√¨ HAXM:

1. M·ªü PowerShell **as Administrator**
2. Ch·∫°y l·ªánh:
   ```powershell
   Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All
   ```
3. Restart m√°y

---

## üì± B∆∞·ªõc 3: T·∫°o Android Virtual Device (AVD)

### 3.1. M·ªü Device Manager

**C√°ch 1:**
- Android Studio ‚Üí Top toolbar ‚Üí Click icon **Device Manager** (icon ƒëi·ªán tho·∫°i)

**C√°ch 2:**
- **Tools** ‚Üí **Device Manager**

**C√°ch 3:**
- **View** ‚Üí **Tool Windows** ‚Üí **Device Manager**

### 3.2. Create New Virtual Device

1. Click **Create Device** (ho·∫∑c n√∫t **+**)

2. **Select Hardware**:
   
   **Recommended devices:**
   - **Pixel 5** - 6.0" 1080x2340, 8GB RAM
   - **Pixel 6** - 6.4" 1080x2400, 8GB RAM
   - **Pixel 7 Pro** - 6.7" 1440x3120, 12GB RAM
   - **Medium Phone** - 6.0" generic device
   
   Click **Next**

3. **Select System Image**:
   
   **Recommended:**
   - **Tiramisu** (API 33) - Android 13.0
   - **S** (API 31) - Android 12.0
   - **R** (API 30) - Android 11.0
   
   **Ch·ªçn image c√≥ label:**
   - üì¶ **x86_64** (cho Intel CPU)
   - üéÆ **Google Play** (c√≥ Google Play Store)
   - üî• **Google APIs** (c√≥ Google services)
   
   **Download n·∫øu ch∆∞a c√≥** (click link Download)
   
   Click **Next**

4. **Verify Configuration**:
   
   - **AVD Name**: `Pixel_5_API_33` (ho·∫∑c t√™n b·∫°n th√≠ch)
   - **Startup orientation**: Portrait
   - **Graphics**: Automatic (ho·∫∑c Hardware - GLES 2.0)
   
   **Advanced Settings** (n·∫øu c·∫ßn customize):
   - **Boot option**: Cold boot (ho·∫∑c Quick boot)
   - **Camera**: 
     - Front: Webcam0 (d√πng camera m√°y b·∫°n)
     - Back: VirtualScene (gi·∫£ l·∫≠p)
   - **Network**:
     - Speed: Full
     - Latency: None
   - **Memory and Storage**:
     - RAM: 2048 MB (t·ªëi thi·ªÉu) - 4096 MB (recommended)
     - VM heap: 256 MB
     - Internal Storage: 2048 MB
     - SD card: 512 MB (optional)
   
   Click **Finish**

### 3.3. T·∫°o nhi·ªÅu AVD cho test

Khuy·∫øn ngh·ªã t·∫°o √≠t nh·∫•t 2-3 devices v·ªõi c·∫•u h√¨nh kh√°c nhau:

1. **Pixel 5 - API 33** (Android 13) - High-end
2. **Medium Phone - API 30** (Android 11) - Mid-range
3. **Small Phone - API 29** (Android 10) - Low-end

---

## üöÄ B∆∞·ªõc 4: Kh·ªüi ƒë·ªông AVD

### 4.1. Start t·ª´ Device Manager

1. M·ªü **Device Manager**
2. T√¨m AVD b·∫°n v·ª´a t·∫°o
3. Click n√∫t **‚ñ∂ (Play)** ƒë·ªÉ start

Emulator s·∫Ω m·ªü trong c·ª≠a s·ªï m·ªõi (ƒë·ª£i 30-60 gi√¢y l·∫ßn ƒë·∫ßu)

### 4.2. Start t·ª´ Command Line

```bash
# List t·∫•t c·∫£ emulators
flutter emulators

# Ho·∫∑c
emulator -list-avds
```

Output:
```
Pixel_5_API_33
Medium_Phone_API_30
```

Start emulator:

```bash
# C√°ch 1: D√πng Flutter
flutter emulators --launch Pixel_5_API_33

# C√°ch 2: D√πng emulator command
emulator -avd Pixel_5_API_33
```

### 4.3. Ki·ªÉm tra device ƒë√£ s·∫µn s√†ng

```bash
flutter devices
```

Output:
```
Found 4 connected devices:
  sdk gphone64 x86 64 (mobile) ‚Ä¢ emulator-5554 ‚Ä¢ android-x64 ‚Ä¢ Android 13 (API 33)
  Windows (desktop)            ‚Ä¢ windows       ‚Ä¢ windows-x64 ‚Ä¢ Microsoft Windows
  Chrome (web)                 ‚Ä¢ chrome        ‚Ä¢ web-javascript ‚Ä¢ Google Chrome
  Edge (web)                   ‚Ä¢ edge          ‚Ä¢ web-javascript ‚Ä¢ Microsoft Edge
```

Ho·∫∑c:

```bash
adb devices
```

Output:
```
List of devices attached
emulator-5554   device
```

---

## üîê B∆∞·ªõc 5: C·∫•u h√¨nh cho Microsoft SSO

### 5.1. Ki·ªÉm tra Google Play Services

1. Trong emulator, m·ªü **Settings**
2. Scroll xu·ªëng ‚Üí **About emulated device**
3. Ki·ªÉm tra **Google Play services** version

N·∫øu kh√¥ng c√≥, b·∫°n c·∫ßn ch·ªçn system image c√≥ **Google Play** khi t·∫°o AVD.

### 5.2. ƒêƒÉng nh·∫≠p Google Account (Quan tr·ªçng!)

1. Trong emulator, m·ªü **Settings**
2. **Accounts** ‚Üí **Add account** ‚Üí **Google**
3. ƒêƒÉng nh·∫≠p v·ªõi Google account
4. Accept terms
5. Ki·ªÉm tra **Play Store** c√≥ ho·∫°t ƒë·ªông kh√¥ng

**L∆∞u √Ω**: Microsoft SSO c·∫ßn Google Play Services ƒë·ªÉ ho·∫°t ƒë·ªông!

### 5.3. Update AndroidManifest.xml

M·ªü file `android/app/src/main/AndroidManifest.xml` v√† th√™m intent-filter cho deep linking:

```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <application>
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:theme="@style/LaunchTheme"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
            android:hardwareAccelerated="true"
            android:windowSoftInputMode="adjustResize">
            
            <!-- Standard launcher intent -->
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
            
            <!-- Deep linking for Microsoft SSO -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data
                    android:scheme="msauth"
                    android:host="com.example.login_register_event"
                    android:path="/qitkjCObmVXTpHslEaOpznysgEk" />
            </intent-filter>
            
            <meta-data
                android:name="io.flutter.embedding.android.NormalTheme"
                android:resource="@style/NormalTheme" />
        </activity>
        
        <meta-data
            android:name="flutterEmbedding"
            android:value="2" />
    </application>
    
    <!-- Internet permission -->
    <uses-permission android:name="android.permission.INTERNET"/>
</manifest>
```

### 5.4. Verify msal_config.dart

Ki·ªÉm tra file `lib/msal_config.dart`:

```dart
// Backend URL cho Android Emulator
const String kBackendUrl = 'http://10.0.2.2:8000';

// Android redirect URI
const String kRedirectUriAndroid = 'msauth://com.example.login_register_event/qitkjCObmVXTpHslEaOpznysgEk';
```

**Gi·∫£i th√≠ch:**
- `10.0.2.2` l√† IP ƒë·∫∑c bi·ªát trong Android Emulator tr·ªè ƒë·∫øn `localhost` c·ªßa m√°y host
- Port `8000` l√† port backend FastAPI ƒëang ch·∫°y

---

## ‚ñ∂Ô∏è B∆∞·ªõc 6: Run Flutter App tr√™n AVD

### 6.1. Kh·ªüi ƒë·ªông Backend

M·ªü terminal v√† start backend:

```bash
cd c:\Users\tdat1\Demo_LoginResisterEvent\backend
uvicorn app.main:app --reload
```

Ki·ªÉm tra backend ho·∫°t ƒë·ªông: [http://localhost:8000/docs](http://localhost:8000/docs)

### 6.2. Run Flutter App

M·ªü terminal m·ªõi:

```bash
cd c:\Users\tdat1\Demo_LoginResisterEvent\frontend\mobile
flutter run
```

Flutter s·∫Ω t·ª± ƒë·ªông detect emulator v√† deploy app.

**Ho·∫∑c ch·ªâ ƒë·ªãnh device c·ª• th·ªÉ:**

```bash
flutter run -d emulator-5554
```

### 6.3. Xem Logs

Trong terminal ƒëang ch·∫°y `flutter run`, b·∫°n s·∫Ω th·∫•y realtime logs.

**Ho·∫∑c xem logs ri√™ng:**

```bash
flutter logs
```

**Ho·∫∑c d√πng ADB logcat:**

```bash
adb logcat | findstr flutter
```

---

## üß™ B∆∞·ªõc 7: Test Microsoft SSO Flow

### 7.1. Test Complete Flow

1. **App kh·ªüi ƒë·ªông**:
   - SplashScreen hi·ªÉn th·ªã
   - Check user ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
   - Navigate ƒë·∫øn LoginScreen (n·∫øu ch∆∞a login)

2. **Click "ƒêƒÉng nh·∫≠p b·∫±ng Microsoft"**:
   - App g·ªçi `flutter_appauth`
   - Browser m·ªü Microsoft login page

3. **ƒêƒÉng nh·∫≠p Microsoft**:
   - Nh·∫≠p email/password Microsoft
   - Accept permissions

4. **Redirect v·ªÅ app**:
   - Browser redirect v·ªõi msauth:// scheme
   - App nh·∫≠n ID token
   - G·ªçi API backend `/auth/sso-login`
   - L∆∞u user info v√†o SharedPreferences
   - Navigate ƒë·∫øn HomeScreen

5. **Restart app**:
   - App t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p
   - Navigate th·∫≥ng ƒë·∫øn HomeScreen

### 7.2. Verify Backend Connection

Trong emulator, m·ªü **Chrome** v√† test:

```
http://10.0.2.2:8000/docs
```

B·∫°n s·∫Ω th·∫•y FastAPI Swagger UI n·∫øu backend ƒëang ch·∫°y.

### 7.3. Test C√°c Ch·ª©c NƒÉng Kh√°c

- ‚úÖ Navigation: LoginScreen ‚Üí HomeScreen
- ‚úÖ Auto-login: Restart app
- ‚úÖ Logout: Clear SharedPreferences
- ‚úÖ Event Registration Form (khi implement)
- ‚úÖ API calls ƒë·∫øn backend

---

## üêõ B∆∞·ªõc 8: Debug v√† Troubleshooting

### 8.1. Enable Developer Options trong Emulator

1. Trong emulator, m·ªü **Settings**
2. **About emulated device**
3. Tap **Build number** 7 l·∫ßn
4. "You are now a developer!"
5. Quay l·∫°i Settings ‚Üí **System** ‚Üí **Developer options**

**Enable c√°c options:**
- ‚úÖ **USB debugging** (m·∫∑c ƒë·ªãnh ƒë√£ b·∫≠t)
- ‚úÖ **Stay awake** (m√†n h√¨nh kh√¥ng t·∫Øt khi charge)
- ‚ùå **Window animation scale** ‚Üí Off (nhanh h∆°n)
- ‚ùå **Transition animation scale** ‚Üí Off
- ‚ùå **Animator duration scale** ‚Üí Off

### 8.2. Debug v·ªõi Android Studio

1. M·ªü project Android trong Android Studio:
   ```
   File ‚Üí Open ‚Üí c:\Users\tdat1\Demo_LoginResisterEvent\frontend\mobile\android
   ```

2. Set breakpoints trong MainActivity.kt (n·∫øu c·∫ßn)

3. Run with debugger:
   ```bash
   flutter run --debug
   ```

### 8.3. Common Issues

#### **Issue 1: Emulator kh√¥ng start**

**Symptoms:**
```
PANIC: Cannot find AVD system path. Please define ANDROID_SDK_ROOT
```

**Solution:**

```bash
# Set environment variable
setx ANDROID_SDK_ROOT "C:\Users\<YourName>\AppData\Local\Android\Sdk"
setx ANDROID_HOME "C:\Users\<YourName>\AppData\Local\Android\Sdk"
```

Restart terminal v√† th·ª≠ l·∫°i.

---

#### **Issue 2: "flutter devices" kh√¥ng th·∫•y emulator**

**Solution:**

```bash
# Kill v√† restart ADB
adb kill-server
adb start-server

# Check l·∫°i
adb devices
flutter devices
```

---

#### **Issue 3: Emulator ch·∫≠m**

**Solutions:**

1. **TƒÉng RAM cho AVD:**
   - Device Manager ‚Üí AVD ‚Üí Edit (pencil icon)
   - Advanced Settings ‚Üí RAM: 4096 MB

2. **Enable Hardware Acceleration:**
   - Graphics: Hardware - GLES 2.0

3. **Gi·∫£m resolution:**
   - Ch·ªçn device nh·ªè h∆°n (Medium Phone thay v√¨ Pixel 7 Pro)

4. **Cold boot thay v√¨ Quick boot:**
   - Advanced Settings ‚Üí Boot option: Cold boot

---

#### **Issue 4: "Cannot connect to backend"**

**Verify:**

```bash
# Check backend ƒëang ch·∫°y
curl http://localhost:8000/docs

# Check t·ª´ emulator Chrome
# Trong emulator: http://10.0.2.2:8000/docs
```

**Solution:**

- ƒê·∫£m b·∫£o backend ch·∫°y
- ƒê·∫£m b·∫£o `msal_config.dart` d√πng `10.0.2.2:8000`
- Check firewall kh√¥ng block port 8000

---

#### **Issue 5: "SSO redirect kh√¥ng ho·∫°t ƒë·ªông"**

**Verify:**

1. AndroidManifest.xml c√≥ intent-filter v·ªõi scheme `msauth`
2. Redirect URI trong Azure Portal kh·ªõp v·ªõi app
3. Google Play Services ƒë√£ c√†i trong emulator
4. ƒê√£ ƒëƒÉng nh·∫≠p Google account trong emulator

**Debug:**

```dart
// Trong login_screen.dart, th√™m logs
print('Starting SSO login...');
print('Redirect URI: $redirectUri');
print('Auth result: $result');
```

---

#### **Issue 6: "Accept Android licenses"**

**Solution:**

```bash
flutter doctor --android-licenses
```

Nh·∫•n `y` ƒë·ªÉ accept t·∫•t c·∫£ licenses.

---

## üìä B∆∞·ªõc 9: Performance Testing

### 9.1. Profile Mode

Build app ·ªü profile mode ƒë·ªÉ test performance:

```bash
flutter run --profile
```

### 9.2. Release Mode

Build production APK:

```bash
flutter build apk --release
```

Install v√†o emulator:

```bash
adb install build/app/outputs/flutter-apk/app-release.apk
```

### 9.3. Flutter DevTools

Open DevTools ƒë·ªÉ monitor performance:

```bash
flutter pub global activate devtools
flutter pub global run devtools
```

Trong terminal ƒëang run app:

```
# Copy URL v√† paste v√†o DevTools
An Observatory debugger and profiler on sdk gphone64 x86 64 is available at: http://127.0.0.1:xxxxx/
```

---

## üéØ Tips & Best Practices

### 10.1. Emulator Shortcuts

| Shortcut | Action |
|----------|--------|
| **Ctrl + M** | Menu |
| **Ctrl + H** | Home |
| **Ctrl + Backspace** | Back |
| **Ctrl + F11** | Rotate left |
| **Ctrl + F12** | Rotate right |
| **Ctrl + P** | Power button |
| **Ctrl + K** | Volume up |
| **Ctrl + L** | Volume down |

### 10.2. Quick Actions

- **Wipe data**: Device Manager ‚Üí AVD ‚Üí ‚ãÆ (More) ‚Üí Wipe Data
- **Cold boot**: Device Manager ‚Üí AVD ‚Üí ‚ãÆ ‚Üí Cold Boot Now
- **Take screenshot**: Emulator ‚Üí ... (Extended controls) ‚Üí Screenshot
- **Record screen**: Extended controls ‚Üí Record and Playback

### 10.3. Multi-device Testing

Run app tr√™n nhi·ªÅu emulators c√πng l√∫c:

```bash
# Terminal 1
flutter run -d emulator-5554

# Terminal 2
flutter run -d emulator-5556
```

### 10.4. Snapshot ƒë·ªÉ boot nhanh

1. Start emulator
2. Setup app (login, data, etc.)
3. Emulator ‚Üí ... ‚Üí Snapshots ‚Üí Save snapshot
4. L·∫ßn sau boot, emulator restore t·ª´ snapshot (r·∫•t nhanh!)

---

## ‚úÖ Pre-flight Checklist

Tr∆∞·ªõc khi test, ƒë·∫£m b·∫£o:

- [ ] Android Studio ƒë√£ c√†i ƒë·∫∑t
- [ ] Android SDK ƒë√£ setup (API 30-33)
- [ ] AVD ƒë√£ t·∫°o v·ªõi Google Play image
- [ ] Emulator ƒë√£ kh·ªüi ƒë·ªông th√†nh c√¥ng
- [ ] `flutter devices` hi·ªÉn th·ªã emulator
- [ ] Google account ƒë√£ ƒëƒÉng nh·∫≠p trong emulator
- [ ] AndroidManifest.xml c√≥ intent-filter cho msauth://
- [ ] Backend ƒëang ch·∫°y (`http://localhost:8000/docs`)
- [ ] `msal_config.dart` d√πng `http://10.0.2.2:8000`
- [ ] Azure Portal ƒë√£ c·∫•u h√¨nh redirect URI v·ªõi signature hash
- [ ] Test backend t·ª´ emulator Chrome: `http://10.0.2.2:8000/docs`

---

## üöÄ Quick Start Guide

N·∫øu ƒë√£ setup xong, workflow test nhanh:

```bash
# Terminal 1: Start backend
cd c:\Users\tdat1\Demo_LoginResisterEvent\backend
uvicorn app.main:app --reload

# Terminal 2: Start emulator
flutter emulators --launch Pixel_5_API_33

# Terminal 3: Run app
cd c:\Users\tdat1\Demo_LoginResisterEvent\frontend\mobile
flutter run
```

---

## üìö Resources

- [Android Emulator Documentation](https://developer.android.com/studio/run/emulator)
- [Flutter + Android Setup](https://docs.flutter.dev/get-started/install/windows#android-setup)
- [AVD Manager Guide](https://developer.android.com/studio/run/managing-avds)
- [ADB Commands](https://developer.android.com/studio/command-line/adb)

---

**Next Steps:**
1. ‚úÖ C√†i ƒë·∫∑t Android Studio
2. ‚úÖ Setup Android SDK
3. ‚úÖ T·∫°o AVD v·ªõi Google Play
4. ‚úÖ Start emulator v√† ƒëƒÉng nh·∫≠p Google
5. ‚úÖ Update AndroidManifest.xml
6. ‚úÖ Run `flutter run` v√† test SSO
7. ‚úÖ Debug v√† fix issues n·∫øu c√≥

Happy Testing! üéâ
